name: CD - Deploy to Production

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma migrate deploy

      # Option 1: Deploy to Railway
      - name: Deploy to Railway
        if: ${{ vars.DEPLOY_TARGET == 'railway' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          npm install -g @railway/cli
          railway up --service execora-api
          railway up --service execora-worker

      # Option 2: Deploy to VPS via SSH
      - name: Deploy to VPS
        if: ${{ vars.DEPLOY_TARGET == 'vps' }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            cd /var/www/execora
            git pull origin main
            npm ci --production
            npm run build
            npx prisma migrate deploy
            pm2 reload ecosystem.config.js --update-env
            pm2 save

      # Option 3: Deploy to DigitalOcean App Platform
      - name: Deploy to DigitalOcean
        if: ${{ vars.DEPLOY_TARGET == 'digitalocean' }}
        uses: digitalocean/app_action@v1.1.5
        with:
          app_name: execora
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # Option 4: Build and push Docker image
      - name: Build and push Docker image
        if: ${{ vars.DEPLOY_TARGET == 'docker' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/execora:latest
            ${{ secrets.DOCKER_REGISTRY }}/execora:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/execora:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/execora:buildcache,mode=max

      - name: Notify deployment success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ✅ Deployment successful!
            
            Environment: ${{ github.event.inputs.environment || 'production' }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Message: ${{ github.event.head_commit.message }}

      - name: Notify deployment failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ❌ Deployment failed!
            
            Environment: ${{ github.event.inputs.environment || 'production' }}
            Commit: ${{ github.sha }}
            Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Check API health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/health)
          if [ $response -eq 200 ]; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed with status $response"
            exit 1
          fi

      - name: Run smoke tests
        run: |
          # Test critical endpoints
          curl -f ${{ secrets.PRODUCTION_URL }}/api/v1/customers/search?q=test || exit 1
          curl -f ${{ secrets.PRODUCTION_URL }}/metrics || exit 1
          echo "✅ Smoke tests passed"
